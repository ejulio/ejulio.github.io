<!doctype html><html lang=pt-br><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="pt-br"><meta name=color-scheme content="light dark"><meta name=author content="Júlio César Batista"><meta name=description content="A matriz de incidência termo-documento é uma das formas de representar um índice de termos por documento. Mesmo usando o conceito de uma matriz esparsa, essa estrutura pode crescer muito para ser usada em memória. Uma alternativa para esse caso é usar um índice invertido (inverted index).
Dados os seguintes documentos como exemplo:
Uma casa à venda em Blumenau Vendo terreno em Gaspar Alugo apartamento em Indaial A matriz de incidência é:"><meta name=keywords content="blog,software,developer"><meta name=twitter:card content="summary"><meta name=twitter:title content="Índice invertido (inverted index)"><meta name=twitter:description content="A matriz de incidência termo-documento é uma das formas de representar um índice de termos por documento. Mesmo usando o conceito de uma matriz esparsa, essa estrutura pode crescer muito para ser usada em memória. Uma alternativa para esse caso é usar um índice invertido (inverted index).
Dados os seguintes documentos como exemplo:
Uma casa à venda em Blumenau Vendo terreno em Gaspar Alugo apartamento em Indaial A matriz de incidência é:"><meta property="og:title" content="Índice invertido (inverted index)"><meta property="og:description" content="A matriz de incidência termo-documento é uma das formas de representar um índice de termos por documento. Mesmo usando o conceito de uma matriz esparsa, essa estrutura pode crescer muito para ser usada em memória. Uma alternativa para esse caso é usar um índice invertido (inverted index).
Dados os seguintes documentos como exemplo:
Uma casa à venda em Blumenau Vendo terreno em Gaspar Alugo apartamento em Indaial A matriz de incidência é:"><meta property="og:type" content="article"><meta property="og:url" content="https://juliocesarbatista.com/posts/indice-invertido/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-12-28T00:00:00+00:00"><meta property="article:modified_time" content="2019-12-28T00:00:00+00:00"><title>Índice invertido (inverted index) · Júlio César Batista</title><link rel=canonical href=https://juliocesarbatista.com/posts/indice-invertido/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.d9fddbffe6f27e69985dc5fe0471cdb0e57fbf4775714bc3d847accb08f4a1f6.css integrity="sha256-2f3b/+byfmmYXcX+BHHNsOV/v0d1cUvD2Eesywj0ofY=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.002ee2378e14c7a68f1f0a53d9694ed252090987c4e768023fac694a4fc5f793.css integrity="sha256-AC7iN44Ux6aPHwpT2WlO0lIJCYfE52gCP6xpSk/F95M=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><meta name=generator content="Hugo 0.116.1"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Júlio César Batista</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/categories/publica%c3%a7%c3%a3o/>Publicações</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/categories/>Categorias</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://juliocesarbatista.com/posts/indice-invertido/>Índice invertido (inverted index)</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2019-12-28T00:00:00Z>2019-12-28</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
4 minutos de leitura</span></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i>
<a href=/categories/recupera%C3%A7%C3%A3o-de-informa%C3%A7%C3%A3o/>Recuperação de informação</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/python/>python</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/inverted-index/>inverted index</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/%C3%ADndice-invertido/>índice invertido</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/boolean-query/>boolean query</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/nltk/>nltk</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/estruturas-de-dados/>estruturas de dados</a></span></div></div></header><div><p><a href=https://juliocesarbatista.com/post/matriz-incidencia-termo-documento/>A matriz de incidência termo-documento</a> é uma das formas de representar um índice de termos por documento.
Mesmo usando o conceito de uma matriz esparsa, essa estrutura pode crescer muito para ser usada em memória.
Uma alternativa para esse caso é usar um índice invertido (<em>inverted index</em>).</p><p>Dados os seguintes documentos como exemplo:</p><ul><li>Uma casa à venda em Blumenau</li><li>Vendo terreno em Gaspar</li><li>Alugo apartamento em Indaial</li></ul><p>A matriz de incidência é:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># matriz de incidência termo-documento
</span></span><span style=display:flex><span>I = [
</span></span><span style=display:flex><span>    #1  2  3    # id do documento
</span></span><span style=display:flex><span>    [0, 0, 1],  # alugo
</span></span><span style=display:flex><span>    [0, 0, 1],  # apartamento
</span></span><span style=display:flex><span>    [1, 0, 0],  # blumenau
</span></span><span style=display:flex><span>    [1, 0, 0],  # casa
</span></span><span style=display:flex><span>    [0, 1, 0],  # gaspar
</span></span><span style=display:flex><span>    [0, 0, 1],  # indaial
</span></span><span style=display:flex><span>    [0, 1, 0],  # terreno
</span></span><span style=display:flex><span>    [1, 1, 0],  # venda
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>O índice invertido é, basicamente, um dicionário.
Nesse exemplo, ele será representado em memória, mas a ideia é que as listas de documentos (<em>posting lists</em>) devem ser persistidas em disco e apenas os termos (chaves do dicionário) devem ficar em memória.
O exemplo anterior como um índice invertido:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># índice invertido
</span></span><span style=display:flex><span>I = {
</span></span><span style=display:flex><span>    &#39;__alldocs__&#39;: [1, 2, 3],
</span></span><span style=display:flex><span>    &#39;alugo&#39;: [3],
</span></span><span style=display:flex><span>    &#39;apartamento&#39;: [3],
</span></span><span style=display:flex><span>    &#39;blumenau&#39;: [1],
</span></span><span style=display:flex><span>    &#39;casa&#39;: [1],
</span></span><span style=display:flex><span>    &#39;gaspar&#39;: [2],
</span></span><span style=display:flex><span>    &#39;indaial&#39;: [3],
</span></span><span style=display:flex><span>    &#39;terreno&#39;: [2],
</span></span><span style=display:flex><span>    &#39;venda&#39;: [1, 2],
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As chaves do dicionário são os termos, também chamado de vocabulário.
Os valores são listas com os <em>ids</em> dos documentos (<em>postings lists</em>).
O detalhe é que, as consultas <em>booleanas</em> agora ficam como operações em conjuntos e não mais como operações <em>bitwise</em>.
Também foi necessário adicionar um termo especial <code>__alldocs__</code> com todos os <em>ids</em>.
Esse termo é necessário para processar consultas com <code>NOT</code>.</p><p>Exemplos de consultas</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># venda AND blumenau
</span></span><span style=display:flex><span>venda = I[&#39;venda&#39;]
</span></span><span style=display:flex><span>blumenau = I[&#39;blumenau&#39;]
</span></span><span style=display:flex><span>set(venda) &amp; set(blumenau)  # intersecção de conjuntos
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># gaspar OR indaial
</span></span><span style=display:flex><span>gaspar = I[&#39;gaspar&#39;]
</span></span><span style=display:flex><span>indaial = I[&#39;indaial&#39;]
</span></span><span style=display:flex><span>set(gaspar) | set(indaial)  # união de conjuntos
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># venda AND NOT gaspar
</span></span><span style=display:flex><span>venda = I[&#39;venda&#39;]
</span></span><span style=display:flex><span>gaspar = I[&#39;gaspar&#39;]
</span></span><span style=display:flex><span>not_gaspar = set(I[&#39;__alldocs__&#39;]) - set(I[&#39;gaspar&#39;])
</span></span><span style=display:flex><span>set(venda) &amp; not_gaspar
</span></span></code></pre></div><p>Para mais detalhes de como funcionam as operações com conjuntos veja <a href=https://juliocesarbatista.com/post/python-sets/>esse post</a>.</p><p>Um exemplo completo de como construir o índice inverso com <a href=http://www.nltk.org/>NLTK</a> e o <a href=https://en.wikipedia.org/wiki/Brown_Corpus>Brown Corpus</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>import string
</span></span><span style=display:flex><span>from itertools import chain
</span></span><span style=display:flex><span>from collections import defaultdict
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>import nltk
</span></span><span style=display:flex><span>from nltk.corpus import brown
</span></span><span style=display:flex><span>from nltk.corpus import stopwords
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># baixa o corpus
</span></span><span style=display:flex><span>nltk.download(&#39;brown&#39;)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># funções de pré-processamento
</span></span><span style=display:flex><span>STOP_WORDS = set(stopwords.words(&#39;english&#39;))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def filtrar_stop_words(doc):
</span></span><span style=display:flex><span>    return (p for p in doc if p not in STOP_WORDS)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def filtrar_pontuacao(doc):
</span></span><span style=display:flex><span>    return (p for p in doc if p not in string.punctuation)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def normalizar_palavras(doc):
</span></span><span style=display:flex><span>    return (p.lower() for p in doc)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># paragrafos no formato de lista de frases
</span></span><span style=display:flex><span># sendo cada frase uma lista de palavras
</span></span><span style=display:flex><span># o correto nesse caso é apenas uma lista de palavras por paragrafo
</span></span><span style=display:flex><span>DOCUMENTOS = brown.paras()
</span></span><span style=display:flex><span>DOCUMENTOS = [list(chain.from_iterable(p)) for p in DOCUMENTOS]
</span></span><span style=display:flex><span># faz uma normalização de texto
</span></span><span style=display:flex><span># deveria ser melhor, mas vai ficar no simples por enquanto
</span></span><span style=display:flex><span>documentos = (normalizar_palavras(p) for p in DOCUMENTOS)
</span></span><span style=display:flex><span># remove pontuação
</span></span><span style=display:flex><span>documentos = (filtrar_pontuacao(p) for p in documentos)
</span></span><span style=display:flex><span># remove stop words
</span></span><span style=display:flex><span>documentos = (filtrar_stop_words(p) for p in documentos)
</span></span><span style=display:flex><span># transforma em uma lista
</span></span><span style=display:flex><span>documentos = [list(p) for p in documentos]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># constrói o índice invertido
</span></span><span style=display:flex><span>inverted_index = defaultdict(list)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>for (doc_id, doc) in enumerate(documentos):
</span></span><span style=display:flex><span>    # termo especial para queries com NOT
</span></span><span style=display:flex><span>    inverted_index[&#39;__alldocs__&#39;].append(doc_id)
</span></span><span style=display:flex><span>    for termo in doc:
</span></span><span style=display:flex><span>        inverted_index[termo].append(doc_id)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># testes
</span></span><span style=display:flex><span>print(&#39;voters AND jury&#39;)
</span></span><span style=display:flex><span>voters = inverted_index[&#39;voters&#39;]
</span></span><span style=display:flex><span>jury = inverted_index[&#39;jury&#39;]
</span></span><span style=display:flex><span>doc_ids = set(voters) &amp; set(jury)
</span></span><span style=display:flex><span>for doc_id in doc_ids:
</span></span><span style=display:flex><span>    print(&#39;&gt; &#39;, &#39; &#39;.join(DOCUMENTOS[doc_id]))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(&#39;voters OR city&#39;)
</span></span><span style=display:flex><span>voters = inverted_index[&#39;voters&#39;]
</span></span><span style=display:flex><span>city = inverted_index[&#39;city&#39;]
</span></span><span style=display:flex><span>doc_ids = set(voters) | set(city)
</span></span><span style=display:flex><span>for doc_id in doc_ids:
</span></span><span style=display:flex><span>    print(&#39;&gt; &#39;, &#39; &#39;.join(DOCUMENTOS[doc_id]))
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>print(&#39;voters AND NOT city&#39;)
</span></span><span style=display:flex><span>voters = inverted_index[&#39;voters&#39;]
</span></span><span style=display:flex><span>city = inverted_index[&#39;city&#39;]
</span></span><span style=display:flex><span>not_city = set(inverted_index[&#39;__alldocs__&#39;]) - set(city)
</span></span><span style=display:flex><span>doc_ids = set(voters) &amp; set(not_city)
</span></span><span style=display:flex><span>for doc_id in doc_ids:
</span></span><span style=display:flex><span>    print(&#39;&gt; &#39;, &#39; &#39;.join(DOCUMENTOS[doc_id]))
</span></span></code></pre></div><p>Idealmente, o índice invertido deve manter apenas o vocabulário em memória.
Os <em>postings</em> (conjunto de todas as <em>postings lists</em>) deve ser armazenado no disco e lido conforme necessidade.
Também é importante notar que em alguns casos é possível armazenar o tamanho da <em>posting list</em>, mas nesse caso foi evitado porque não era necessário no momento e com <code>python</code> basta executar <code>len()</code> para obter o valor.</p><p>A principal vantagem do índice invertido sobre a matriz de incidência é o uso de memória.
Enquanto a matriz precisa ficar em memória, o índice pode ficar parcialmente no disco.
Outro detalhe é que o índice invertido guarda apenas os documentos com ocorrência dos termos.
Apesar que esse problema foi resolvido usando uma matriz esparsa, que guarda apenas os valores diferentes de <code>0</code>.
Finalmente, é possível estender os algoritmos de processamento de um índice invertido para otimizar a busca ou até mesmo adicionar mais meta dados (como a posição do termo no documento).</p><h2 id=referências>Referências
<a class=heading-link href=#refer%c3%aancias><i class="fa fa-link" aria-hidden=true></i></a></h2><ul><li><a href=https://www.systems.ethz.ch/sites/default/files/file/ir2018spring/02%20Information%20Retrieval%20-%20Boolean%20Retrieval.pdf>2. Boolean Retrieval</a></li><li><a href=https://nlp.stanford.edu/IR-book/html/htmledition/a-first-take-at-building-an-inverted-index-1.html>A first take at building an inverted index</a></li></ul></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2016 -
2023
Júlio César Batista
·
Promovido por <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.9cf2dbf9b6989ef8eae941ffb4231c26d1dc026bca38f1d19fdba50177d8a9ac.js integrity="sha256-nPLb+baYnvjq6UH/tCMcJtHcAmvKOPHRn9ulAXfYqaw="></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1BE56W9H8M"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1BE56W9H8M",{anonymize_ip:!1})}</script></body></html>