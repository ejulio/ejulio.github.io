<!doctype html><html class=no-js lang=en-us>
<head>
<meta charset=utf-8>
<title>Executando consultas por frases: Positional Index | Júlio César Batista</title>
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet href=https://juliocesarbatista.com/css/foundation.min.css>
<link rel=stylesheet href=https://juliocesarbatista.com/css/highlight.min.css>
<link rel=stylesheet href=https://juliocesarbatista.com/css/font-awesome.min.css>
<link rel=stylesheet href=https://juliocesarbatista.com/css/academicons.min.css>
<link rel=stylesheet href=https://juliocesarbatista.com/css/fonts.css>
<link rel=stylesheet href=https://juliocesarbatista.com/css/finite.css>
</head>
<body>
<header>
<nav class=nav-bar>
<div class=title-bar data-responsive-toggle=site-menu data-hide-for=medium>
<button class=site-hamburger type=button data-toggle>
<i class="fa fa-bars fa-lg" aria-hidden=true></i>
</button>
<div class="title-bar-title site-title">
<a href=https://juliocesarbatista.com/>Júlio César Batista</a>
</div>
<div class="title-bar-right pull-right">
</div>
</div>
<div class=top-bar id=site-menu>
<div class="top-bar-title show-for-medium site-title">
<a href=https://juliocesarbatista.com/>Júlio César Batista</a>
</div>
<div class=top-bar-left>
<ul class="menu vertical medium-horizontal">
<li><a href=https://juliocesarbatista.com/publication/>Publicações</a></li>
<li><a href=https://juliocesarbatista.com/post/>Blog</a></li>
<li><a href=https://juliocesarbatista.com/logbook/>Recursos</a></li>
</ul>
</div>
<div class="top-bar-right show-for-medium">
</div>
</div>
</nav>
</header>
<main>
<div class=row>
<div class="column small-12 medium-10 medium-offset-1 end large-8 large-offset-0">
<article class=article itemscope itemtype=http://schema.org/Article>
<h1 itemprop=name>Executando consultas por frases: Positional Index</h1>
<div class=post-metadata>
<span class=post-date>
<time datetime="2020-01-20 00:00:00 +0000 UTC" itemprop=datePublished>
2020/01/20
</time>
</span>
<span class=post-categories>
<span class=nowrap>
<a href=https://juliocesarbatista.com/categories/recupera%c3%a7%c3%a3o-de-informa%c3%a7%c3%a3o>Recuperação de informação</a>
</span>
</span>
<span class=post-tags>
<span class=nowrap><i class="fa fa-tags"></i>
<a href=https://juliocesarbatista.com/tags/python>python</a>
,
<a href=https://juliocesarbatista.com/tags/positional-index>positional index</a>
,
<a href=https://juliocesarbatista.com/tags/phrase-queries>phrase queries</a>
,
<a href=https://juliocesarbatista.com/tags/positional-intersect>positional intersect</a>
</span>
</span>
</div>
<div class=post-body itemprop=articleBody>
<p>Para realizar a consulta por frases (sequências de palavras) é necessário um <a href=https://juliocesarbatista.com/post/phrase-queries/>índice <em>k-gram</em></a>.
Porém, criar um índice todas as combinações de termos pode ocupar muito espaço em disco/memória.
Principalmente se for necessário indexar combinações de 5 ou mais palavras, visto que muitas combinações podem aparecer apenas uma ou outra vez.
Uma solução para esse problema é um <em>positional index</em> (índice de posições).</p>
<p>Em um índice invertido, termos são mapeados para listas com <em>ids</em> de documentos.
No <em>positional index</em>, além dos <em>ids</em>, também são mantidas as posições em que o termo aparece no documento.</p>
<p>Seguindo os documentos de exemplo:</p>
<ul>
<li>Uma casa à venda em Blumenau</li>
<li>Vendo terreno em Gaspar</li>
<li>Alugo apartamento em Indaial</li>
</ul>
<p>O <em>positional index</em> seria</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>
positional_index <span style=color:#f92672>=</span> {
    <span style=color:#e6db74>&#34;Uma&#34;</span>: {
        <span style=color:#ae81ff>0</span>: [<span style=color:#ae81ff>0</span>]
    },
    <span style=color:#e6db74>&#34;casa&#34;</span>: {
        <span style=color:#ae81ff>0</span>: [<span style=color:#ae81ff>1</span>]
    },
    <span style=color:#e6db74>&#34;à&#34;</span>: {
        <span style=color:#ae81ff>0</span>: [<span style=color:#ae81ff>2</span>]
    },
    <span style=color:#e6db74>&#34;venda&#34;</span>: {
        <span style=color:#ae81ff>0</span>: [<span style=color:#ae81ff>3</span>]
    },
    <span style=color:#e6db74>&#34;em&#34;</span>: {
        <span style=color:#ae81ff>0</span>: [<span style=color:#ae81ff>4</span>],
        <span style=color:#ae81ff>1</span>: [<span style=color:#ae81ff>2</span>],
        <span style=color:#ae81ff>2</span>: [<span style=color:#ae81ff>2</span>]
    },
    <span style=color:#e6db74>&#34;Blumenau&#34;</span>: {
        <span style=color:#ae81ff>0</span>: [<span style=color:#ae81ff>5</span>]
    },
    <span style=color:#e6db74>&#34;Vendo&#34;</span>: {
        <span style=color:#ae81ff>1</span>: [<span style=color:#ae81ff>0</span>]
    },
    <span style=color:#e6db74>&#34;terreno&#34;</span>: {
        <span style=color:#ae81ff>1</span>: [<span style=color:#ae81ff>1</span>]
    },
    <span style=color:#e6db74>&#34;Gaspar&#34;</span>: {
        <span style=color:#ae81ff>1</span>: [<span style=color:#ae81ff>3</span>]
    },
    <span style=color:#e6db74>&#34;Alugo&#34;</span>: {
        <span style=color:#ae81ff>2</span>: [<span style=color:#ae81ff>0</span>]
    },
    <span style=color:#e6db74>&#34;apartamento&#34;</span>: {
        <span style=color:#ae81ff>2</span>: [<span style=color:#ae81ff>1</span>]
    },
    <span style=color:#e6db74>&#34;Indaial&#34;</span>: {
        <span style=color:#ae81ff>2</span>: [<span style=color:#ae81ff>3</span>]
    }
}
</code></pre></div><p>A partir desse índice, é possível reconstruir os documentos, visto que existe a identificação dos documentos e posição em que cada termo aparece nos documentos.
Porém, a grande vantagem é que consultas por sequências de palavras podem ser executadas para qualquer quantidade.
Por exemplo, a consulta <code>casa em blumenau</code> pode ser executada, já que é possível encontrar os documentos e verificar se os termos <code>casa</code>, <code>em</code>, <code>blumenau</code> aparecem em sequência nesses documentos.
Também é possível executar consultas em intervalos/janelas (<em>windows</em>), como <code>casa \3 blumenau</code> (<em>proximity query</em>) indicando que se deseja todos os documentos onde <code>blumenau</code> aparece em até três termos de distância de <code>casa</code>.
Para executar essas consultas, é necessário implementar o algoritmo de <code>positional_intersect</code>, como demonstrado na <a href=https://nlp.stanford.edu/IR-book/html/htmledition/positional-indexes-1.html>seção Positional Indexes de <em>Introduction to Information Retrieval</em></a>.</p>
<p>Para construir o <em>positional index</em>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>
<span style=color:#f92672>import</span> nltk
<span style=color:#f92672>from</span> nltk.corpus <span style=color:#f92672>import</span> brown
<span style=color:#f92672>from</span> itertools <span style=color:#f92672>import</span> chain
<span style=color:#f92672>import</span> string
<span style=color:#f92672>from</span> collections <span style=color:#f92672>import</span> defaultdict

nltk<span style=color:#f92672>.</span>download(<span style=color:#e6db74>&#39;brown&#39;</span>)

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>filtrar_pontuacao</span>(doc):
    <span style=color:#66d9ef>return</span> (p <span style=color:#66d9ef>for</span> p <span style=color:#f92672>in</span> doc <span style=color:#66d9ef>if</span> p <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> string<span style=color:#f92672>.</span>punctuation)

DOCUMENTOS <span style=color:#f92672>=</span> brown<span style=color:#f92672>.</span>paras()
DOCUMENTOS <span style=color:#f92672>=</span> [list(chain<span style=color:#f92672>.</span>from_iterable(p)) <span style=color:#66d9ef>for</span> p <span style=color:#f92672>in</span> DOCUMENTOS]
documentos <span style=color:#f92672>=</span> (filtrar_pontuacao(p) <span style=color:#66d9ef>for</span> p <span style=color:#f92672>in</span> DOCUMENTOS)
documentos <span style=color:#f92672>=</span> [list(p) <span style=color:#66d9ef>for</span> p <span style=color:#f92672>in</span> documentos]

positional_index <span style=color:#f92672>=</span> defaultdict(<span style=color:#66d9ef>lambda</span>: defaultdict(list))

<span style=color:#66d9ef>for</span> (doc_id, doc) <span style=color:#f92672>in</span> enumerate(documentos):
    <span style=color:#66d9ef>for</span> (i, termo) <span style=color:#f92672>in</span> enumerate(doc):
        positional_index[termo][doc_id]<span style=color:#f92672>.</span>append(i)
</code></pre></div><p>O algoritmo <code>positional_intersect</code> é similar a intersecção de listas, a diferença é que ele também verifica se a posição dos termos está em até uma distância <code>k</code>.
Na implementação abaixo, a grande diferença fica no bloco <code>else</code> que percorre as posições que os termos ocorrem e verifica se a posição do <em>termo 1</em> está até <code>k</code> distância da posição do <em>termo 2</em> (<code>abs(pp1_pos - pp2_pos) &lt;= k</code>).
O resultado é uma lista de tuplas contendo o <em>id</em> do documento e posição dos <em>termo 1</em> e <em>termo 2</em>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>positional_intersect</span>(p1, p2, k):
    answer <span style=color:#f92672>=</span> []

    p1 <span style=color:#f92672>=</span> iter(p1<span style=color:#f92672>.</span>items())
    p2 <span style=color:#f92672>=</span> iter(p2<span style=color:#f92672>.</span>items())
    (p1_doc_id, pp1) <span style=color:#f92672>=</span> next(p1, (<span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>None</span>))
    (p2_doc_id, pp2) <span style=color:#f92672>=</span> next(p2, (<span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>None</span>))
    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> (p1_doc_id <span style=color:#f92672>and</span> p2_doc_id):
            <span style=color:#66d9ef>break</span>

        <span style=color:#66d9ef>if</span> p1_doc_id <span style=color:#f92672>&lt;</span> p2_doc_id:
            (p1_doc_id, pp1) <span style=color:#f92672>=</span> next(p1, (<span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>None</span>))
        <span style=color:#66d9ef>elif</span> p1_doc_id <span style=color:#f92672>&gt;</span> p2_doc_id:
            (p2_doc_id, pp2) <span style=color:#f92672>=</span> next(p2, (<span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>None</span>))
        <span style=color:#66d9ef>else</span>:
            <span style=color:#66d9ef>for</span> pp1_pos <span style=color:#f92672>in</span> pp1:
                l <span style=color:#f92672>=</span> []
                <span style=color:#66d9ef>for</span> pp2_pos <span style=color:#f92672>in</span> pp2:
                    <span style=color:#66d9ef>if</span> abs(pp1_pos <span style=color:#f92672>-</span> pp2_pos) <span style=color:#f92672>&lt;=</span> k:
                        answer<span style=color:#f92672>.</span>append((p1_doc_id, pp1_pos, pp2_pos))
                    <span style=color:#66d9ef>elif</span> pp2_pos <span style=color:#f92672>&gt;</span> pp1_pos:
                        <span style=color:#66d9ef>break</span>
            (p1_doc_id, pp1) <span style=color:#f92672>=</span> next(p1, (<span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>None</span>))
            (p2_doc_id, pp2) <span style=color:#f92672>=</span> next(p2, (<span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>None</span>))

    <span style=color:#66d9ef>return</span> answer

p1 <span style=color:#f92672>=</span> {<span style=color:#ae81ff>1</span>: [<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>100</span>]}
p2 <span style=color:#f92672>=</span> {<span style=color:#ae81ff>2</span>: [<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>101</span>]}
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>==</span> []
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>1</span>) <span style=color:#f92672>==</span> []
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>2</span>) <span style=color:#f92672>==</span> []
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>3</span>) <span style=color:#f92672>==</span> []

p1 <span style=color:#f92672>=</span> {<span style=color:#ae81ff>1</span>: [<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>100</span>]}
p2 <span style=color:#f92672>=</span> {<span style=color:#ae81ff>1</span>: [<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>101</span>]}
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>==</span> []
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>1</span>) <span style=color:#f92672>==</span> [(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>), (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>11</span>), (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>101</span>)]
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>2</span>) <span style=color:#f92672>==</span> [(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>), (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>11</span>), (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>101</span>)]
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>3</span>) <span style=color:#f92672>==</span> [(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>), (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>11</span>), (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>101</span>)]


p1 <span style=color:#f92672>=</span> {<span style=color:#ae81ff>1</span>: [<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>200</span>]}
p2 <span style=color:#f92672>=</span> {<span style=color:#ae81ff>1</span>: [<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>13</span>, <span style=color:#ae81ff>102</span>, <span style=color:#ae81ff>204</span>]}
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>==</span> []
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>1</span>) <span style=color:#f92672>==</span> [(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>)]
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>2</span>) <span style=color:#f92672>==</span> [(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>), (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>102</span>)]
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>3</span>) <span style=color:#f92672>==</span> [(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>), (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>13</span>), (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>102</span>)]

p1 <span style=color:#f92672>=</span> {<span style=color:#ae81ff>1</span>: [<span style=color:#ae81ff>1</span>]}
p2 <span style=color:#f92672>=</span> {<span style=color:#ae81ff>1</span>: [<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>13</span>, <span style=color:#ae81ff>102</span>, <span style=color:#ae81ff>204</span>]}
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>==</span> []
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>1</span>) <span style=color:#f92672>==</span> [(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>)]
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>2</span>) <span style=color:#f92672>==</span> [(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>)]
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>3</span>) <span style=color:#f92672>==</span> [(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>)]

p1 <span style=color:#f92672>=</span> {<span style=color:#ae81ff>1</span>: [<span style=color:#ae81ff>1</span>]}
p2 <span style=color:#f92672>=</span> {<span style=color:#ae81ff>1</span>: [<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>]}
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>==</span> []
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>1</span>) <span style=color:#f92672>==</span> [(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>)]
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>2</span>) <span style=color:#f92672>==</span> [(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>), (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>3</span>)]
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>3</span>) <span style=color:#f92672>==</span> [(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>), (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>3</span>)]

p1 <span style=color:#f92672>=</span> {<span style=color:#ae81ff>1</span>: [<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>]}
p2 <span style=color:#f92672>=</span> {<span style=color:#ae81ff>1</span>: [<span style=color:#ae81ff>1</span>]}
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>==</span> []
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>1</span>) <span style=color:#f92672>==</span> [(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>1</span>)]
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>2</span>) <span style=color:#f92672>==</span> [(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>1</span>), (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>1</span>)]
<span style=color:#66d9ef>assert</span> positional_intersect(p1, p2, <span style=color:#ae81ff>3</span>) <span style=color:#f92672>==</span> [(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>1</span>), (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>1</span>)]
</code></pre></div><p>Vale notar que o algoritmo considera a distância <code>k</code> em ambas as direções, portanto, <em>termo 2</em> pode aparecer até <code>k</code> termos antes ou depois de <em>termo 1</em>.
Abaixo segue o mesmo exemplo da consulta de índices <em>k-gram</em>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>print(<span style=color:#e6db74>&#39;House /2 Representatives&#39;</span>)
house <span style=color:#f92672>=</span> positional_index[<span style=color:#e6db74>&#39;House&#39;</span>]
representatives <span style=color:#f92672>=</span> positional_index[<span style=color:#e6db74>&#39;Representatives&#39;</span>]
<span style=color:#66d9ef>for</span> (doc_id, p1, p2) <span style=color:#f92672>in</span> positional_intersect(house, representatives, <span style=color:#ae81ff>2</span>):
    print(
        <span style=color:#e6db74>&#39;&gt;&#39;</span>,
        <span style=color:#e6db74>&#39;[&#39;</span>,
        doc_id,
        p1,
        p2,
        <span style=color:#e6db74>&#39;]&#39;</span>,
        <span style=color:#e6db74>&#39; &#39;</span><span style=color:#f92672>.</span>join(documentos[doc_id][p1 <span style=color:#f92672>-</span> <span style=color:#ae81ff>3</span>:p2 <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span>])
    )
    print(<span style=color:#e6db74>&#39; &#39;</span><span style=color:#f92672>.</span>join(DOCUMENTOS[doc_id]))
    print()
</code></pre></div><p>Sendo o resultado (omitindo os textos para economizar espaço):</p>
<blockquote>
<p>House /2 Representatives</p>
</blockquote>
<blockquote>
<p>[ 102 15 17 ] by the Texas House of Representatives was an</p>
</blockquote>
<blockquote>
<p>[ 1889 61 63 ] representative with the House of Representatives turned guest</p>
</blockquote>
<blockquote>
<p>[ 7792 83 85 ] pushed through the House of Representatives by the</p>
</blockquote>
<blockquote>
<p>[ 8008 9 11 ] terms in the House of Representatives has been</p>
</blockquote>
<blockquote>
<p>[ 8010 28 30 ] Speaker of the House of Representatives more than</p>
</blockquote>
<blockquote>
<p>[ 8015 45 47 ] Member of the House of Representatives in the</p>
</blockquote>
<blockquote>
<p>[ 8189 7 9 ] the Senate and House of Representatives of the</p>
</blockquote>
<blockquote>
<p>[ 8199 7 9 ] the Senate and House of Representatives of the</p>
</blockquote>
<blockquote>
<p>[ 8202 7 9 ] the Senate and House of Representatives of the</p>
</blockquote>
<blockquote>
<p>[ 8525 65 67 ] Senate and the House of Representatives As I</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>print(<span style=color:#e6db74>&#39;Texas House /2 Representatives&#39;</span>)
texas <span style=color:#f92672>=</span> positional_index[<span style=color:#e6db74>&#39;Texas&#39;</span>]
house <span style=color:#f92672>=</span> positional_index[<span style=color:#e6db74>&#39;House&#39;</span>]
texas_house <span style=color:#f92672>=</span> defaultdict(list)
<span style=color:#66d9ef>for</span> (doc_id, _, i) <span style=color:#f92672>in</span> positional_intersect(texas, house, <span style=color:#ae81ff>1</span>):
    <span style=color:#75715e># ignora a posição de &#34;Texas&#34;, visto que &#34;House&#34;</span>
    <span style=color:#75715e># será usado na próxima comparação</span>
    texas_house[doc_id]<span style=color:#f92672>.</span>append(i)

representatives <span style=color:#f92672>=</span> positional_index[<span style=color:#e6db74>&#39;Representatives&#39;</span>]
<span style=color:#66d9ef>for</span> (doc_id, p1, p2) <span style=color:#f92672>in</span> positional_intersect(texas_house, representatives, <span style=color:#ae81ff>2</span>):
    print(
        <span style=color:#e6db74>&#39;&gt;&#39;</span>,
        <span style=color:#e6db74>&#39;[&#39;</span>,
        doc_id,
        p1,
        p2,
        <span style=color:#e6db74>&#39;]&#39;</span>,
        <span style=color:#e6db74>&#39; &#39;</span><span style=color:#f92672>.</span>join(documentos[doc_id][p1 <span style=color:#f92672>-</span> <span style=color:#ae81ff>3</span>:p2 <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span>])
    )
    print(<span style=color:#e6db74>&#39; &#39;</span><span style=color:#f92672>.</span>join(DOCUMENTOS[doc_id]))
    print()

</code></pre></div><p>Sendo o resultado</p>
<blockquote>
<p>Texas House /2 Representatives</p>
</blockquote>
<blockquote>
<p>[ 102 15 17 ] by the Texas House of Representatives was an
Rep. James Cotten of Weatherford insisted that a water development bill passed by the Texas House of Representatives was an effort by big cities like Dallas and Fort Worth to cover up places like Paradise , a Wise County hamlet of 250 people .</p>
</blockquote>
<p>Vale notar que o <em>positional index</em> resolve a possibilidade de consultas com sequências indeterminadas de palavras.
Porém, elevando o custo computacional (requer executar mais interseções) e com um leve aumento de armazenamento (armazenar posições dos termos).
Mesmo assim, ainda pode ser melhor que usar índices <em>k-gram</em>.
Sendo que a melhor abordagem pode ser uma combinação híbrida dos dois índices.
Por exemplo, combinações muito frequentes de palavras, como <em>machine learning</em>, <em>Elvis Presley</em> poderiam ser pré-computadas e armazenadas num índice <em>k-gram</em> para evitar o uso do <em>positional index</em>, já que são consultas/frases frequentes.
Outro detalhe é a combinação de <em>stop words</em>, por exemplo <em>of the</em> ou <em>The Who</em> (banda), já que tendem a ser listas grandes e executar a intersecção pode ser muito custoso em cada execução.
Portanto, o melhor índice vai depender do caso de uso, mas uma solução conjunta pode ser a melhor solução após a análise de frequência de consultas.</p>
<h2 id=referências>Referências</h2>
<ul>
<li><a href=https://nlp.stanford.edu/IR-book/html/htmledition/positional-indexes-1.html>Positional Indexes</a></li>
<li><a href=https://www.systems.ethz.ch/sites/default/files/file/ir2018spring/04%20Information%20Retrieval%20-%20Tolerant%20retrieval.pdf>Tolerant Retrieval</a></li>
<li><a href=http://web.stanford.edu/class/cs276/19handouts/lecture2-intro-boolean-1per.pdf>Inverted Indices: Dictionary and postings lists, boolean querying</a></li>
</ul>
</div>
<meta itemprop=wordCount content="1351">
<meta itemprop=datePublished content="2020-01-20">
<meta itemprop=url content="https://juliocesarbatista.com/post/phrase-queries-positional-index/">
</article>
<ul class=pagination role=navigation aria-label=Pagination>
<li class=arrow aria-disabled=true><a href=https://juliocesarbatista.com/post/compressao-indices-vbe/>&#171; <em>Previous<span class=show-for-sr> page</span></em>: Compressão de índices: Variable Byte Encoding</a></li>
<li class=arrow aria-disabled=true><a href=https://juliocesarbatista.com/post/correcao-ortografica-k-gram-index/><em>Next<span class=show-for-sr> page</span></em>: Correção ortográfica com índice k-gram&nbsp;&#187;</a></li>
</ul>
</div>
</div>
</main>
<footer>
<hr>
<div class=row>
<div class="column small-10 small-centered text-center">
<em>Gostou ou tem algum comentário? Vamos conversar no <span class=nowrap><i class="fa fa-twitter-square"></i> Twitter</span>, <a href=http://twitter.com/ejuliobatista>@ejuliobatista</a>!</em>
</div>
</div>
</footer>
<div class=endofpage>
</div>
<script src=https://juliocesarbatista.com/js/jquery.js></script>
<script src=https://juliocesarbatista.com/js/what-input.js></script>
<script src=https://juliocesarbatista.com/js/foundation.min.js></script>
<script src=https://juliocesarbatista.com/js/finite.js></script>
<script src=https://juliocesarbatista.com/js/highlight.pack.js></script>
<script>hljs.initHighlightingOnLoad()</script>
<script type=text/x-mathjax-config>
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [['$','$'], ['\\(','\\)']],
          processEscapes: true
        }
      });
    </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML" async></script>
</body>
</html>