<!doctype html><html lang=pt-br><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="pt-br"><meta name=color-scheme content="light dark"><meta name=author content="Júlio César Batista"><meta name=description content="A partir de um índice de termos/documentos só é possível efetuar consultas de ocorrência de termos e filtros com operadores AND, OR e NOT. Entretanto, o que é preciso para executar uma consulta por presidente do Brasil? A forma mais simples, é converter essa consulta em presidente AND do AND Brasil (o do pode ser removido se quiser remover stop words). O detalhe é que essa consulta vai retornar qualquer documento que contenha presidente e Brasil, mas que não não fale necessariamento do presidente do Brasil."><meta name=keywords content="blog,software,developer"><meta name=twitter:card content="summary"><meta name=twitter:title content="Executando consultas por frases"><meta name=twitter:description content="A partir de um índice de termos/documentos só é possível efetuar consultas de ocorrência de termos e filtros com operadores AND, OR e NOT. Entretanto, o que é preciso para executar uma consulta por presidente do Brasil? A forma mais simples, é converter essa consulta em presidente AND do AND Brasil (o do pode ser removido se quiser remover stop words). O detalhe é que essa consulta vai retornar qualquer documento que contenha presidente e Brasil, mas que não não fale necessariamento do presidente do Brasil."><meta property="og:title" content="Executando consultas por frases"><meta property="og:description" content="A partir de um índice de termos/documentos só é possível efetuar consultas de ocorrência de termos e filtros com operadores AND, OR e NOT. Entretanto, o que é preciso para executar uma consulta por presidente do Brasil? A forma mais simples, é converter essa consulta em presidente AND do AND Brasil (o do pode ser removido se quiser remover stop words). O detalhe é que essa consulta vai retornar qualquer documento que contenha presidente e Brasil, mas que não não fale necessariamento do presidente do Brasil."><meta property="og:type" content="article"><meta property="og:url" content="https://juliocesarbatista.com/posts/phrase-queries/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-01-03T00:00:00+00:00"><meta property="article:modified_time" content="2020-01-03T00:00:00+00:00"><title>Executando consultas por frases · Júlio César Batista</title><link rel=canonical href=https://juliocesarbatista.com/posts/phrase-queries/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.d9fddbffe6f27e69985dc5fe0471cdb0e57fbf4775714bc3d847accb08f4a1f6.css integrity="sha256-2f3b/+byfmmYXcX+BHHNsOV/v0d1cUvD2Eesywj0ofY=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.002ee2378e14c7a68f1f0a53d9694ed252090987c4e768023fac694a4fc5f793.css integrity="sha256-AC7iN44Ux6aPHwpT2WlO0lIJCYfE52gCP6xpSk/F95M=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><meta name=generator content="Hugo 0.115.3"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Júlio César Batista</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>Sobre</a></li><li class=navigation-item><a class=navigation-link href=/categories/publica%c3%a7%c3%a3o/>Publicações</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/categories/>Categorias</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://juliocesarbatista.com/posts/phrase-queries/>Executando consultas por frases</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2020-01-03T00:00:00Z>2020-01-03</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
6 minutos de leitura</span></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i>
<a href=/categories/recupera%C3%A7%C3%A3o-de-informa%C3%A7%C3%A3o/>Recuperação de informação</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/python/>python</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/k-gram-index/>k-gram index</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/bi-word-index/>bi-word index</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/phrase-queries/>phrase queries</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/phrase-index/>phrase index</a></span></div></div></header><div><p>A partir de um <a href=https://juliocesarbatista.com/post/indice-invertido/>índice de termos/documentos</a> só é possível efetuar consultas de ocorrência de termos e filtros com operadores <code>AND</code>, <code>OR</code> e <code>NOT</code>.
Entretanto, o que é preciso para executar uma consulta por <em>presidente do Brasil</em>?
A forma mais simples, é converter essa consulta em <code>presidente AND do AND Brasil</code> (o <em>do</em> pode ser removido se quiser remover <em>stop words</em>).
O detalhe é que essa consulta vai retornar qualquer documento que contenha <em>presidente</em> e <em>Brasil</em>, mas que não não fale necessariamento do <em>presidente do Brasil</em>.
Um exemplo seria: <em>O presidente do conselho está trabalhando para aumentar os empregos no Brasil</em>.
Esse documento é retornado pela consulta <code>presidente AND do AND Brasil</code>, mas não tem nada a ver com <em>presidente do Brasil</em>.
Portanto, é necessário melhorar a estrutura de índice para obter melhores resultados pelas consultas.</p><p>Antes de prosseguir, é importante notar que esse tipo de consulta normalmente é feito com <code>"</code>.
Portanto, pesquisar por <em>presidente do Brasil</em> é o equivalente à <code>presidente AND do AND Brasil</code>.
Para efetuar a consulta com a <em>phrase query</em> é necessário adicionar <code>"</code>, assim <em>&ldquo;presidente do Brasil&rdquo;</em> faz a consulta pela frase.
Claro que é possível adicionar algum mecanismo que interpréte <em>presidente do Brasil</em> como uma <em>phrase query</em>, sem a necessidade de pedir ao usuário que coloque <code>"</code>.</p><h2 id=índice-_bi-word_>índice <em>bi-word</em>
<a class=heading-link href=#%c3%adndice-_bi-word_><i class="fa fa-link" aria-hidden=true></i></a></h2><p>Uma forma de resolver a consulta por frases é criar um índice de <em>k</em>-palavras.
Sendo 2-palavras um número bom, visto que $k \gt 2$ começa a requisitar mais espaço de armazenamento para todas as combinações de três ou mais palavras.
Portanto, dados os <a href=https://juliocesarbatista.com/post/indice-invertido/>documentos de exemplo usado no índice invertido</a>, o índice <em>bi-word</em> (2-palavras) seria.</p><p>Documentos:</p><ul><li>Uma casa à venda em Blumenau: <code>[casa, venda, Blumenau]</code>: <code>[(casa, venda), (venda, Blumenau)]</code></li><li>Vendo terreno em Gaspar: <code>[venda, terreno, Gaspar]</code>: <code>[(venda, terreno), (terreno, Gaspar)]</code></li><li>Alugo apartamento em Indaial: <code>[alugo, apartamento, Indaial]</code>: <code>[(alugo, apartamento), (apartamento, Indaial)]</code></li></ul><p>Observação: As <em>stop words</em> foram removidas para simplificar o exemplo.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># índice bi-word
</span></span><span style=display:flex><span>I = {
</span></span><span style=display:flex><span>    &#39;__alldocs__&#39;: [1, 2, 3],
</span></span><span style=display:flex><span>    (&#39;alugo&#39;, &#39;apartamento&#39;): [3],
</span></span><span style=display:flex><span>    (&#39;apartamento&#39;, &#39;Indaial&#39;): [3],
</span></span><span style=display:flex><span>    (&#39;casa&#39;, &#39;venda&#39;): [1],
</span></span><span style=display:flex><span>    (&#39;terreno&#39;, &#39;Gaspar&#39;): [2],
</span></span><span style=display:flex><span>    (&#39;venda&#39;, &#39;Blumenau&#39;): [1],
</span></span><span style=display:flex><span>    (&#39;venda&#39;, &#39;terreno&#39;): [2],
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Como é possível notar no exemplo acima, a diferença fica que as chaves do dicionário são tuplas (poderia ser uma <em>string</em> concatenada também) de palavras em sequência.
É necessário atentar na hora de efetuar a consulta.
Nesse momento, uma consulta <em>terreno em Gaspar</em> não se torna <code>terreno AND Gaspar</code>, mas sim <code>terreno Gaspar</code>.</p><p>Voltando ao exemplo da consulta <em>presidente do Brasil</em>.
Com a condição de um índice de duas palavras, a consulta seria <code>presidente do AND do Brasil</code>.
Note que a consulta foi separada em um <code>AND</code> com as sequências de <em>k</em>-palavras possíveis.</p><p>Um exemplo de como montar um índice <em>bi-word</em> em <code>python</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>import nltk
</span></span><span style=display:flex><span>from nltk.corpus import brown
</span></span><span style=display:flex><span>from itertools import chain
</span></span><span style=display:flex><span>import string
</span></span><span style=display:flex><span>from collections import defaultdict
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nltk.download(&#39;brown&#39;)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def filtrar_pontuacao(doc):
</span></span><span style=display:flex><span>    return (p for p in doc if p not in string.punctuation)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DOCUMENTOS = brown.paras()
</span></span><span style=display:flex><span>DOCUMENTOS = [list(chain.from_iterable(p)) for p in DOCUMENTOS]
</span></span><span style=display:flex><span>documentos = (filtrar_pontuacao(p) for p in DOCUMENTOS)
</span></span><span style=display:flex><span>documentos = [list(p) for p in documentos]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>bi_word_inverted_index = defaultdict(list)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>for (doc_id, doc) in enumerate(documentos):
</span></span><span style=display:flex><span>    # termo especial para queries com NOT
</span></span><span style=display:flex><span>    bi_word_inverted_index[&#39;__alldocs__&#39;].append(doc_id)
</span></span><span style=display:flex><span>    for (t1, t2) in zip(doc[:-1], doc[1:]):
</span></span><span style=display:flex><span>        bi_word_inverted_index[(t1, t2)].append(doc_id)
</span></span></code></pre></div><p>Agora é possível comparar uma consulta nesse índice <em>bi-word</em>, contra o <a href=https://juliocesarbatista.com/post/indice-invertido/>índice de termos</a>.
O teste será de uma consulta para <em>Texas House of Representatives</em>.</p><p>No índice de termos</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>print(&#39;texas AND house AND representatives&#39;)
</span></span><span style=display:flex><span>texas = inverted_index[&#39;texas&#39;]
</span></span><span style=display:flex><span>house = inverted_index[&#39;house&#39;]
</span></span><span style=display:flex><span>representatives = inverted_index[&#39;representatives&#39;]
</span></span><span style=display:flex><span>doc_ids = set(texas) &amp; set(house) &amp; set(representatives)
</span></span><span style=display:flex><span>for doc_id in doc_ids:
</span></span><span style=display:flex><span>    print(&#39;&gt; &#39;, &#39; &#39;.join(DOCUMENTOS[doc_id]))
</span></span></code></pre></div><p>Com resultados:</p><ul><li><blockquote><p>Under Formby&rsquo;s plan , an appointee would be selected by a board composed of the governor , lieutenant governor , speaker of the House , attorney general and chief justice of the Texas Supreme Court . Austin , Texas &ndash; State representatives decided Thursday against taking a poll on what kind of taxes Texans would prefer to pay .</p></blockquote></li><li><blockquote><p>Rep. James Cotten of Weatherford insisted that a water development bill passed by the Texas House of Representatives was an effort by big cities like Dallas and Fort Worth to cover up places like Paradise , a Wise County hamlet of 250 people .</p></blockquote></li></ul><p>Note que o primeiro resultado contém todos os termos, mas não na sequência desejada.
Já o segundo documento é um resultado esperado para a consulta.</p><p>A mesma consulta no índice <em>bi-word</em></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>print(&#39;texas house AND house of AND of representatives&#39;)
</span></span><span style=display:flex><span>texas_house = bi_word_inverted_index[(&#39;Texas&#39;, &#39;House&#39;)]
</span></span><span style=display:flex><span>house_of = inverted_index[(&#39;House&#39;, &#39;of&#39;)]
</span></span><span style=display:flex><span>of_representatives = inverted_index[(&#39;of&#39;, &#39;Representatives&#39;)]
</span></span><span style=display:flex><span>doc_ids = set(texas_house) &amp; set(house_of) &amp; set(of_representatives)
</span></span><span style=display:flex><span>for doc_id in doc_ids:
</span></span><span style=display:flex><span>    print(&#39;&gt; &#39;, &#39; &#39;.join(DOCUMENTOS[doc_id]))
</span></span></code></pre></div><p>Com resultado:</p><blockquote><p>Rep. James Cotten of Weatherford insisted that a water development bill passed by the Texas House of Representatives was an effort by big cities like Dallas and Fort Worth to cover up places like Paradise , a Wise County hamlet of 250 people .</p></blockquote><p>Nesse caso, o único documento retornado foi o esperado.
Obviamente esses foram exemplos simples e a ideia é combinar o índice de termos com um índice <em>bi-word</em> para ter um conjunto melhor de resultados.</p><p>Entretanto, ainda existe um problema no índice <em>bi-word</em>.
Nesse exemplo, em inglês, tirado de <em><a href=https://nlp.stanford.edu/IR-book/html/htmledition/biword-indexes-1.html>Introduction to Information Retrieval</a></em>, fica claro.
Indexar <em>renegotiation of the constitution</em> seria: <code>[(renegotiation, of), (of, the), (the, constitution)]</code>.
Note que esses índices de duas palavras não agregam muito e, provavelmente, retornariam resultado irrelevantes em uma consulta.
A solução é pensar em aumentar de 2-palavras para 3-palavras ou 4-palavras.
O problema é o tamanho do índice, que começa a ficar muito grande, considerando as várias combinações de 3, ou 4, palavras.
Outra possibilidade é considerar um pouco da estrutura do idioma.
Por exemplo, <code>of the</code> funcionam como palavras auxiliares, <em>stop words</em> até certo ponto, e poderiam ser agregadas ao montar o índice.
Para isso, é necessário uma lista de <em>stop words</em> ou usar técnicas de Processamento de Linguagem Natural para fazer o <em>Part-of-Speech tagging</em>, que indica a função (verbo, substantivo, artigo, &mldr;) de cada palavra em uma frase.
Uma vez que se sabe a função das palavras é possível montar o índice ignorando palavras de estrutura (artigos, preposições, &mldr;) que aparecem entre substantivos/verbos.
Portanto, dado que <em>renegotiation of the constitution</em> seria anotado como <em>N X X N</em> (N: substantivo, X: palavra auxiliar).
Uma estrutura de índice poderia ser montada com <code>NX*N</code>, ou seja, um substantivo (<code>N</code>) seguido por zero ou mais palavras auxiliares (<code>X*</code>) seguido por mais um substantivo (<code>N</code>).
Essa alternativa para considerar os casos especiais onde é necessário indexar mais que duas palavras em sequência é chamada de <em>phrase index</em>, visto que frases completas podem ser indexadas e não apenas termos ou sequências fixas de <em>k</em>-termos.</p><p>O índice <em>bi-word</em> é uma forma para resolver o problema de consultas por frases.
Mas tem a limitação de espaço, visto que indexar sequências muito grandes pode ser proibitivo (em espaço) e também resultar em uma consulta demorada.</p><h2 id=referências>Referências
<a class=heading-link href=#refer%c3%aancias><i class="fa fa-link" aria-hidden=true></i></a></h2><ul><li><a href=https://nlp.stanford.edu/IR-book/html/htmledition/positional-postings-and-phrase-queries-1.html>Positional postings and phrase queries</a></li><li><a href=https://www.systems.ethz.ch/sites/default/files/03%20Information%20Retrieval%20-%20Term%20vocabulary.pdf>3. Term Vocabulary</a></li></ul></div><footer></footer></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})'></script></section></div><footer class=footer><section class=container>©
2016 -
2023
Júlio César Batista
·
Promovido por <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.9cf2dbf9b6989ef8eae941ffb4231c26d1dc026bca38f1d19fdba50177d8a9ac.js integrity="sha256-nPLb+baYnvjq6UH/tCMcJtHcAmvKOPHRn9ulAXfYqaw="></script></body></html>