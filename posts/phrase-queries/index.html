<!doctype html><html lang=pt-br><head><title>Executando consultas por frases · Júlio César Batista
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Júlio César Batista"><meta name=description content="A partir de um índice de termos/documentos só é possível efetuar consultas de ocorrência de termos e filtros com operadores AND, OR e NOT. Entretanto, o que é preciso para executar uma consulta por presidente do Brasil? A forma mais simples, é converter essa consulta em presidente AND do AND Brasil (o do pode ser removido se quiser remover stop words). O detalhe é que essa consulta vai retornar qualquer documento que contenha presidente e Brasil, mas que não não fale necessariamento do presidente do Brasil."><meta name=keywords content="blog,software,developer"><meta name=fediverse:creator content><meta name=twitter:card content="summary"><meta name=twitter:title content="Executando consultas por frases"><meta name=twitter:description content="A partir de um índice de termos/documentos só é possível efetuar consultas de ocorrência de termos e filtros com operadores AND, OR e NOT. Entretanto, o que é preciso para executar uma consulta por presidente do Brasil? A forma mais simples, é converter essa consulta em presidente AND do AND Brasil (o do pode ser removido se quiser remover stop words). O detalhe é que essa consulta vai retornar qualquer documento que contenha presidente e Brasil, mas que não não fale necessariamento do presidente do Brasil."><meta property="og:url" content="https://juliocesarbatista.com/posts/phrase-queries/"><meta property="og:site_name" content="Júlio César Batista"><meta property="og:title" content="Executando consultas por frases"><meta property="og:description" content="A partir de um índice de termos/documentos só é possível efetuar consultas de ocorrência de termos e filtros com operadores AND, OR e NOT. Entretanto, o que é preciso para executar uma consulta por presidente do Brasil? A forma mais simples, é converter essa consulta em presidente AND do AND Brasil (o do pode ser removido se quiser remover stop words). O detalhe é que essa consulta vai retornar qualquer documento que contenha presidente e Brasil, mas que não não fale necessariamento do presidente do Brasil."><meta property="og:locale" content="pt_br"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-01-03T00:00:00+00:00"><meta property="article:modified_time" content="2020-01-03T00:00:00+00:00"><meta property="article:tag" content="Recuperação De Informação"><meta property="article:tag" content="Python"><meta property="article:tag" content="K-Gram Index"><meta property="article:tag" content="Bi-Word Index"><meta property="article:tag" content="Phrase Queries"><meta property="article:tag" content="Phrase Index"><link rel=canonical href=https://juliocesarbatista.com/posts/phrase-queries/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.07092c1350ffd254998dc43a44ae96e617d14af4df4602626878df89189c5e1a.css integrity="sha256-BwksE1D/0lSZjcQ6RK6W5hfRSvTfRgJiaHjfiRicXho=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://juliocesarbatista.com/>Júlio César Batista
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/tags/publica%c3%a7%c3%a3o/>Publicações</a></li><li class=navigation-item><a class=navigation-link href=/tags/projeto/>Projetos</a></li><li class=navigation-item><a class=navigation-link href=/tags/notas/>Notas</a></li><li class=navigation-item><a class=navigation-link href=/tags/>Tags</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://juliocesarbatista.com/posts/phrase-queries/>Executando consultas por frases</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2020-01-03T00:00:00Z>2020-01-03
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
6 minutos de leitura</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/recupera%C3%A7%C3%A3o-de-informa%C3%A7%C3%A3o/>Recuperação De Informação</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/python/>Python</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/k-gram-index/>K-Gram Index</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/bi-word-index/>Bi-Word Index</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/phrase-queries/>Phrase Queries</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/phrase-index/>Phrase Index</a></span></div></div></header><div class=post-content><p>A partir de um <a href=https://juliocesarbatista.com/post/indice-invertido/ class=external-link target=_blank rel=noopener>índice de termos/documentos</a> só é possível efetuar consultas de ocorrência de termos e filtros com operadores <code>AND</code>, <code>OR</code> e <code>NOT</code>.
Entretanto, o que é preciso para executar uma consulta por <em>presidente do Brasil</em>?
A forma mais simples, é converter essa consulta em <code>presidente AND do AND Brasil</code> (o <em>do</em> pode ser removido se quiser remover <em>stop words</em>).
O detalhe é que essa consulta vai retornar qualquer documento que contenha <em>presidente</em> e <em>Brasil</em>, mas que não não fale necessariamento do <em>presidente do Brasil</em>.
Um exemplo seria: <em>O presidente do conselho está trabalhando para aumentar os empregos no Brasil</em>.
Esse documento é retornado pela consulta <code>presidente AND do AND Brasil</code>, mas não tem nada a ver com <em>presidente do Brasil</em>.
Portanto, é necessário melhorar a estrutura de índice para obter melhores resultados pelas consultas.</p><p>Antes de prosseguir, é importante notar que esse tipo de consulta normalmente é feito com <code>"</code>.
Portanto, pesquisar por <em>presidente do Brasil</em> é o equivalente à <code>presidente AND do AND Brasil</code>.
Para efetuar a consulta com a <em>phrase query</em> é necessário adicionar <code>"</code>, assim <em>&ldquo;presidente do Brasil&rdquo;</em> faz a consulta pela frase.
Claro que é possível adicionar algum mecanismo que interpréte <em>presidente do Brasil</em> como uma <em>phrase query</em>, sem a necessidade de pedir ao usuário que coloque <code>"</code>.</p><h2 id=índice-_bi-word_>índice <em>bi-word</em>
<a class=heading-link href=#%c3%adndice-_bi-word_><i class="fa-solid fa-link" aria-hidden=true title="Link para o cabeçalho"></i>
<span class=sr-only>Link para o cabeçalho</span></a></h2><p>Uma forma de resolver a consulta por frases é criar um índice de <em>k</em>-palavras.
Sendo 2-palavras um número bom, visto que $k \gt 2$ começa a requisitar mais espaço de armazenamento para todas as combinações de três ou mais palavras.
Portanto, dados os <a href=https://juliocesarbatista.com/post/indice-invertido/ class=external-link target=_blank rel=noopener>documentos de exemplo usado no índice invertido</a>, o índice <em>bi-word</em> (2-palavras) seria.</p><p>Documentos:</p><ul><li>Uma casa à venda em Blumenau: <code>[casa, venda, Blumenau]</code>: <code>[(casa, venda), (venda, Blumenau)]</code></li><li>Vendo terreno em Gaspar: <code>[venda, terreno, Gaspar]</code>: <code>[(venda, terreno), (terreno, Gaspar)]</code></li><li>Alugo apartamento em Indaial: <code>[alugo, apartamento, Indaial]</code>: <code>[(alugo, apartamento), (apartamento, Indaial)]</code></li></ul><p>Observação: As <em>stop words</em> foram removidas para simplificar o exemplo.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># índice bi-word
</span></span><span style=display:flex><span>I = {
</span></span><span style=display:flex><span>    &#39;__alldocs__&#39;: [1, 2, 3],
</span></span><span style=display:flex><span>    (&#39;alugo&#39;, &#39;apartamento&#39;): [3],
</span></span><span style=display:flex><span>    (&#39;apartamento&#39;, &#39;Indaial&#39;): [3],
</span></span><span style=display:flex><span>    (&#39;casa&#39;, &#39;venda&#39;): [1],
</span></span><span style=display:flex><span>    (&#39;terreno&#39;, &#39;Gaspar&#39;): [2],
</span></span><span style=display:flex><span>    (&#39;venda&#39;, &#39;Blumenau&#39;): [1],
</span></span><span style=display:flex><span>    (&#39;venda&#39;, &#39;terreno&#39;): [2],
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Como é possível notar no exemplo acima, a diferença fica que as chaves do dicionário são tuplas (poderia ser uma <em>string</em> concatenada também) de palavras em sequência.
É necessário atentar na hora de efetuar a consulta.
Nesse momento, uma consulta <em>terreno em Gaspar</em> não se torna <code>terreno AND Gaspar</code>, mas sim <code>terreno Gaspar</code>.</p><p>Voltando ao exemplo da consulta <em>presidente do Brasil</em>.
Com a condição de um índice de duas palavras, a consulta seria <code>presidente do AND do Brasil</code>.
Note que a consulta foi separada em um <code>AND</code> com as sequências de <em>k</em>-palavras possíveis.</p><p>Um exemplo de como montar um índice <em>bi-word</em> em <code>python</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>import nltk
</span></span><span style=display:flex><span>from nltk.corpus import brown
</span></span><span style=display:flex><span>from itertools import chain
</span></span><span style=display:flex><span>import string
</span></span><span style=display:flex><span>from collections import defaultdict
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nltk.download(<span style=font-style:italic>&#39;brown&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>def</span> filtrar_pontuacao(doc):
</span></span><span style=display:flex><span>    <span style=font-weight:700>return</span> (p <span style=font-weight:700>for</span> p <span style=font-weight:700>in</span> doc <span style=font-weight:700>if</span> p <span style=font-weight:700>not</span> <span style=font-weight:700>in</span> string.punctuation)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DOCUMENTOS = brown.paras()
</span></span><span style=display:flex><span>DOCUMENTOS = [list(chain.from_iterable(p)) <span style=font-weight:700>for</span> p <span style=font-weight:700>in</span> DOCUMENTOS]
</span></span><span style=display:flex><span>documentos = (filtrar_pontuacao(p) <span style=font-weight:700>for</span> p <span style=font-weight:700>in</span> DOCUMENTOS)
</span></span><span style=display:flex><span>documentos = [list(p) <span style=font-weight:700>for</span> p <span style=font-weight:700>in</span> documentos]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>bi_word_inverted_index = defaultdict(list)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>for</span> (doc_id, doc) <span style=font-weight:700>in</span> enumerate(documentos):
</span></span><span style=display:flex><span>    <span style=font-style:italic># termo especial para queries com NOT</span>
</span></span><span style=display:flex><span>    bi_word_inverted_index[<span style=font-style:italic>&#39;__alldocs__&#39;</span>].append(doc_id)
</span></span><span style=display:flex><span>    <span style=font-weight:700>for</span> (t1, t2) <span style=font-weight:700>in</span> zip(doc[:-1], doc[1:]):
</span></span><span style=display:flex><span>        bi_word_inverted_index[(t1, t2)].append(doc_id)
</span></span></code></pre></div><p>Agora é possível comparar uma consulta nesse índice <em>bi-word</em>, contra o <a href=https://juliocesarbatista.com/post/indice-invertido/ class=external-link target=_blank rel=noopener>índice de termos</a>.
O teste será de uma consulta para <em>Texas House of Representatives</em>.</p><p>No índice de termos</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>print(&#39;texas AND house AND representatives&#39;)
</span></span><span style=display:flex><span>texas = inverted_index[&#39;texas&#39;]
</span></span><span style=display:flex><span>house = inverted_index[&#39;house&#39;]
</span></span><span style=display:flex><span>representatives = inverted_index[&#39;representatives&#39;]
</span></span><span style=display:flex><span>doc_ids = set(texas) &amp; set(house) &amp; set(representatives)
</span></span><span style=display:flex><span>for doc_id in doc_ids:
</span></span><span style=display:flex><span>    print(&#39;&gt; &#39;, &#39; &#39;.join(DOCUMENTOS[doc_id]))
</span></span></code></pre></div><p>Com resultados:</p><ul><li><blockquote><p>Under Formby&rsquo;s plan , an appointee would be selected by a board composed of the governor , lieutenant governor , speaker of the House , attorney general and chief justice of the Texas Supreme Court . Austin , Texas &ndash; State representatives decided Thursday against taking a poll on what kind of taxes Texans would prefer to pay .</p></blockquote></li><li><blockquote><p>Rep. James Cotten of Weatherford insisted that a water development bill passed by the Texas House of Representatives was an effort by big cities like Dallas and Fort Worth to cover up places like Paradise , a Wise County hamlet of 250 people .</p></blockquote></li></ul><p>Note que o primeiro resultado contém todos os termos, mas não na sequência desejada.
Já o segundo documento é um resultado esperado para a consulta.</p><p>A mesma consulta no índice <em>bi-word</em></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>print(&#39;texas house AND house of AND of representatives&#39;)
</span></span><span style=display:flex><span>texas_house = bi_word_inverted_index[(&#39;Texas&#39;, &#39;House&#39;)]
</span></span><span style=display:flex><span>house_of = inverted_index[(&#39;House&#39;, &#39;of&#39;)]
</span></span><span style=display:flex><span>of_representatives = inverted_index[(&#39;of&#39;, &#39;Representatives&#39;)]
</span></span><span style=display:flex><span>doc_ids = set(texas_house) &amp; set(house_of) &amp; set(of_representatives)
</span></span><span style=display:flex><span>for doc_id in doc_ids:
</span></span><span style=display:flex><span>    print(&#39;&gt; &#39;, &#39; &#39;.join(DOCUMENTOS[doc_id]))
</span></span></code></pre></div><p>Com resultado:</p><blockquote><p>Rep. James Cotten of Weatherford insisted that a water development bill passed by the Texas House of Representatives was an effort by big cities like Dallas and Fort Worth to cover up places like Paradise , a Wise County hamlet of 250 people .</p></blockquote><p>Nesse caso, o único documento retornado foi o esperado.
Obviamente esses foram exemplos simples e a ideia é combinar o índice de termos com um índice <em>bi-word</em> para ter um conjunto melhor de resultados.</p><p>Entretanto, ainda existe um problema no índice <em>bi-word</em>.
Nesse exemplo, em inglês, tirado de <em><a href=https://nlp.stanford.edu/IR-book/html/htmledition/biword-indexes-1.html class=external-link target=_blank rel=noopener>Introduction to Information Retrieval</a></em>, fica claro.
Indexar <em>renegotiation of the constitution</em> seria: <code>[(renegotiation, of), (of, the), (the, constitution)]</code>.
Note que esses índices de duas palavras não agregam muito e, provavelmente, retornariam resultado irrelevantes em uma consulta.
A solução é pensar em aumentar de 2-palavras para 3-palavras ou 4-palavras.
O problema é o tamanho do índice, que começa a ficar muito grande, considerando as várias combinações de 3, ou 4, palavras.
Outra possibilidade é considerar um pouco da estrutura do idioma.
Por exemplo, <code>of the</code> funcionam como palavras auxiliares, <em>stop words</em> até certo ponto, e poderiam ser agregadas ao montar o índice.
Para isso, é necessário uma lista de <em>stop words</em> ou usar técnicas de Processamento de Linguagem Natural para fazer o <em>Part-of-Speech tagging</em>, que indica a função (verbo, substantivo, artigo, &mldr;) de cada palavra em uma frase.
Uma vez que se sabe a função das palavras é possível montar o índice ignorando palavras de estrutura (artigos, preposições, &mldr;) que aparecem entre substantivos/verbos.
Portanto, dado que <em>renegotiation of the constitution</em> seria anotado como <em>N X X N</em> (N: substantivo, X: palavra auxiliar).
Uma estrutura de índice poderia ser montada com <code>NX*N</code>, ou seja, um substantivo (<code>N</code>) seguido por zero ou mais palavras auxiliares (<code>X*</code>) seguido por mais um substantivo (<code>N</code>).
Essa alternativa para considerar os casos especiais onde é necessário indexar mais que duas palavras em sequência é chamada de <em>phrase index</em>, visto que frases completas podem ser indexadas e não apenas termos ou sequências fixas de <em>k</em>-termos.</p><p>O índice <em>bi-word</em> é uma forma para resolver o problema de consultas por frases.
Mas tem a limitação de espaço, visto que indexar sequências muito grandes pode ser proibitivo (em espaço) e também resultar em uma consulta demorada.</p><h2 id=referências>Referências
<a class=heading-link href=#refer%c3%aancias><i class="fa-solid fa-link" aria-hidden=true title="Link para o cabeçalho"></i>
<span class=sr-only>Link para o cabeçalho</span></a></h2><ul><li><a href=https://nlp.stanford.edu/IR-book/html/htmledition/positional-postings-and-phrase-queries-1.html class=external-link target=_blank rel=noopener>Positional postings and phrase queries</a></li><li><a href=https://www.systems.ethz.ch/sites/default/files/03%20Information%20Retrieval%20-%20Term%20vocabulary.pdf class=external-link target=_blank rel=noopener>3. Term Vocabulary</a></li></ul></div><footer></footer></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})'></script></section></div><footer class=footer><section class=container>©
2016 -
2024
Júlio César Batista
·
Promovido por <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-1BE56W9H8M"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1BE56W9H8M")}</script></body></html>